{% extends "base.html" %}

{% block title %}{% if entry.is_some() %}Edit{% else %}Add{% endif %} Link - Interne{% endblock %}

{% block content %}
<div class="form-page">
    <h1 class="form-heading">
        {% if entry.is_some() %}Edit Link{% else %}Add Link{% endif %}
    </h1>

    <form id="entry-form" method="post" action="{% if let Some(e) = entry %}/entries/{{ e.id }}{% else %}/entries{% endif %}" autocomplete="off" novalidate>
        <div class="form-group">
            <label for="url">URL</label>
            <input
                type="text"
                id="url"
                name="url"
                autofocus
                value="{% if let Some(e) = entry %}{{ e.url }}{% endif %}"
                placeholder="example.com"
            >
            <div class="error-message">{% if let Some(err) = errors.get("url") %}{{ err }}{% endif %}</div>
        </div>

        <div class="form-group">
            <label for="title">Title</label>
            <input
                type="text"
                id="title"
                name="title"
                value="{% if let Some(e) = entry %}{{ e.title }}{% endif %}"
            >
            <div class="error-message">{% if let Some(err) = errors.get("title") %}{{ err }}{% endif %}</div>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea
                id="description"
                name="description"
                rows="3"
                maxlength="5000"
            >{% if let Some(e) = entry %}{% if let Some(desc) = &e.description %}{{ desc }}{% endif %}{% endif %}</textarea>
            <div class="char-count" id="desc-count"></div>
            <div class="error-message">{% if let Some(err) = errors.get("description") %}{{ err }}{% endif %}</div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="duration">Revisit Every</label>
                <input
                    type="number"
                    id="duration"
                    name="duration"
                    value="{% if let Some(e) = entry %}{{ e.duration }}{% else %}1{% endif %}"
                >
                <div class="error-message">{% if let Some(err) = errors.get("duration") %}{{ err }}{% endif %}</div>
            </div>

            <div class="form-group">
                <label for="interval">Interval</label>
                <select id="interval" name="interval" required>
                    <option value="hours" {% if let Some(e) = entry %}{% if e.interval.to_string() == "hours" %}selected{% endif %}{% endif %}>Hours</option>
                    <option value="days" {% if let Some(e) = entry %}{% if e.interval.to_string() == "days" %}selected{% endif %}{% else %}selected{% endif %}>Days</option>
                    <option value="weeks" {% if let Some(e) = entry %}{% if e.interval.to_string() == "weeks" %}selected{% endif %}{% endif %}>Weeks</option>
                    <option value="months" {% if let Some(e) = entry %}{% if e.interval.to_string() == "months" %}selected{% endif %}{% endif %}>Months</option>
                    <option value="years" {% if let Some(e) = entry %}{% if e.interval.to_string() == "years" %}selected{% endif %}{% endif %}>Years</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="tags">Tags</label>
            <div class="tags-autocomplete-wrapper">
                <input
                    type="text"
                    id="tags"
                    name="tags"
                    value="{{ tags_string }}"
                    placeholder="comma, separated, tags"
                >
                <div class="tags-autocomplete" id="tags-autocomplete"></div>
            </div>
        </div>

        <div class="form-group">
            <label for="collection_id">Collection</label>
            <select id="collection_id" name="collection_id">
                <option value="">Private</option>
                {% for collection in collections %}
                <option
                    value="{{ collection.id }}"
                    {% if let Some(e) = entry %}{% if e.collection_id == Some(collection.id.clone()) %}selected{% endif %}{% endif %}
                >
                    {{ collection.name }}
                </option>
                {% endfor %}
            </select>
        </div>

    </form>

    <div class="form-actions">
        <button type="submit" form="entry-form">Save</button>
        <a href="/">Cancel</a>
        {% if entry.is_some() %}
        <button
            type="button"
            class="link-button delete-button"
            hx-delete="/entries/{{ entry.as_ref().unwrap().id }}"
            hx-confirm="Are you sure you want to delete this link?"
        >
            Delete
        </button>
        {% endif %}
    </div>
</div>

<script>
(function() {
    var form = document.getElementById('entry-form');

    var rules = {
        url: function(v) {
            if (!v.trim()) return 'URL is required';
            // Loose check: must have a dot somewhere in the domain portion
            var s = v.trim();
            if (s.startsWith('http://') || s.startsWith('https://')) {
                s = s.replace(/^https?:\/\//, '');
            } else if (s.indexOf('://') !== -1) {
                return 'Please enter a valid URL (e.g. example.com)';
            }
            var domain = s.split(/[/?#]/)[0];
            if (!domain.includes('.')) return 'Please enter a valid URL (e.g. example.com)';
            return '';
        },
        title: function(v) {
            if (!v.trim()) return 'Title is required';
            if (v.length > 500) return 'Title must be under 500 characters';
            return '';
        },
        duration: function(v) {
            if (!v || parseInt(v, 10) < 1) return 'Duration must be at least 1';
            return '';
        },
        description: function(v) {
            if (v && v.length > 5000) return 'Description must be under 5000 characters';
            return '';
        }
    };

    function showError(name, msg) {
        var input = form.querySelector('[name="' + name + '"]');
        var errDiv = input.closest('.form-group').querySelector('.error-message');
        if (errDiv) errDiv.textContent = msg;
    }

    function validateField(name) {
        var input = form.querySelector('[name="' + name + '"]');
        if (!input || !rules[name]) return true;
        var msg = rules[name](input.value);
        showError(name, msg);
        return !msg;
    }

    // Validate on blur, clear on input
    ['url', 'title', 'duration', 'description'].forEach(function(name) {
        var input = form.querySelector('[name="' + name + '"]');
        if (input) {
            input.addEventListener('blur', function() { validateField(name); });
            input.addEventListener('input', function() { showError(name, ''); });
        }
    });

    // Validate all on submit
    form.addEventListener('submit', function(e) {
        var valid = true;
        ['url', 'title', 'duration', 'description'].forEach(function(name) {
            if (!validateField(name)) valid = false;
        });
        if (!valid) e.preventDefault();
    });

    // Character counter for description
    var ta = document.getElementById('description');
    var counter = document.getElementById('desc-count');
    var max = 5000;
    function update() {
        var len = ta.value.length;
        if (len > 0) {
            counter.textContent = len + ' / ' + max;
            counter.classList.toggle('near-limit', len >= max * 0.9);
        } else {
            counter.textContent = '';
        }
    }
    ta.addEventListener('input', update);
    update();
})();
</script>

<script>
(function() {
    var input = document.getElementById('tags');
    var dropdown = document.getElementById('tags-autocomplete');
    if (!input || !dropdown) return;

    var debounceTimer = null;
    var activeIndex = -1;

    function getCurrentSegment() {
        var parts = input.value.split(',');
        return parts[parts.length - 1].trim();
    }

    function getExistingTags() {
        return input.value.split(',')
            .map(function(s) { return s.trim().toLowerCase(); })
            .filter(function(s) { return s.length > 0; });
    }

    function replaceCurrentSegment(tagName) {
        var parts = input.value.split(',');
        if (parts.length === 1) {
            parts[0] = tagName;
        } else {
            parts[parts.length - 1] = ' ' + tagName;
        }
        input.value = parts.join(',') + ', ';
        input.focus();
        hideDropdown();
    }

    function showDropdown(html) {
        dropdown.innerHTML = html;
        dropdown.style.display = html ? 'block' : 'none';
        activeIndex = -1;
    }

    function hideDropdown() {
        dropdown.style.display = 'none';
        dropdown.innerHTML = '';
        activeIndex = -1;
    }

    function updateActiveItem() {
        var items = dropdown.querySelectorAll('.autocomplete-item');
        items.forEach(function(el) { el.classList.remove('active'); });
        if (activeIndex >= 0 && activeIndex < items.length) {
            items[activeIndex].classList.add('active');
            items[activeIndex].scrollIntoView({ block: 'nearest' });
        }
    }

    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        var segment = getCurrentSegment();
        if (!segment) {
            hideDropdown();
            return;
        }
        debounceTimer = setTimeout(function() {
            fetch('/api/tags/search?q=' + encodeURIComponent(segment.toLowerCase()))
                .then(function(r) { return r.text(); })
                .then(function(html) {
                    var existing = getExistingTags();
                    var temp = document.createElement('div');
                    temp.innerHTML = html;
                    var buttons = temp.querySelectorAll('.autocomplete-item');
                    buttons.forEach(function(btn) {
                        if (existing.indexOf(btn.getAttribute('data-value')) !== -1) {
                            btn.remove();
                        }
                    });
                    showDropdown(temp.innerHTML);
                });
        }, 300);
    });

    input.addEventListener('keydown', function(e) {
        var items = dropdown.querySelectorAll('.autocomplete-item');
        if (!items.length || dropdown.style.display === 'none') return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = (activeIndex + 1) % items.length;
            updateActiveItem();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = (activeIndex - 1 + items.length) % items.length;
            updateActiveItem();
        } else if (e.key === 'Enter' && activeIndex >= 0) {
            e.preventDefault();
            replaceCurrentSegment(items[activeIndex].getAttribute('data-value'));
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });

    dropdown.addEventListener('click', function(e) {
        var item = e.target.closest('.autocomplete-item');
        if (item) {
            replaceCurrentSegment(item.getAttribute('data-value'));
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tags-autocomplete-wrapper')) {
            hideDropdown();
        }
    });
})();
</script>
{% endblock %}
